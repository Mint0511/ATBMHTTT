{% extends "base.html" %}

{% block title %}Dashboard Giáo Viên{% endblock %}

{% block extra_style %}
.btn-custom {
    margin-bottom: 10px;
}
{% endblock %}

{% block content %}
<!-- User Info Card -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-user-circle"></i> Thông Tin Cá Nhân</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p class="mb-2"><strong>Tên đăng nhập:</strong> {{ user_info.username }}</p>
                <p class="mb-2"><strong>Họ và tên:</strong> {{ user_info.full_name }}</p>
                <p class="mb-0"><strong>Mã giáo viên:</strong> {{ user_info.teacher_id }}</p>
            </div>
            <div class="col-md-6">
                <p class="mb-2"><strong>Email:</strong> {{ user_info.email }}</p>
                <p class="mb-0"><strong>Lớp giảng dạy:</strong> {{ user_info.class_name }}</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <h4><i class="fas fa-upload"></i> Upload đề thi mới</h4>
        <a href="{{ url_for('upload') }}" class="btn btn-success btn-custom">
            <i class="fas fa-plus"></i> UPLOAD ĐỀ THI
        </a>
    </div>
    <div class="col-md-6">
        <h4><i class="fas fa-tasks"></i> Quản lý</h4>
        <a href="{{ url_for('approve_students') }}" class="btn btn-info btn-custom">
            <i class="fas fa-user-check"></i> DUYỆT YÊU CẦU NHÓM
        </a>
        <a href="{{ url_for('manage_groups') }}" class="btn btn-secondary btn-custom">
            <i class="fas fa-users"></i> QUẢN LÝ LỚP
        </a>
        <a href="{{ url_for('manage_students') }}" class="btn btn-secondary btn-custom">
            <i class="fas fa-graduation-cap"></i> QUẢN LÝ SINH VIÊN
        </a>
    </div>
</div>

<h4><i class="fas fa-file-alt"></i> Đề thi đã upload</h4>
{% if group_data %}
<div class="accordion" id="groupsAccordion">
    {% for gid, data in group_data.items() %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ gid }}">
            <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ gid }}" aria-expanded="{% if loop.first %}true{% else %}false{% endif %}" aria-controls="collapse{{ gid }}">
                <i class="fas fa-users me-2"></i>{{ data.name }} ({{ data.exams|length }} đề thi)
            </button>
        </h2>
        <div id="collapse{{ gid }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="heading{{ gid }}" data-bs-parent="#groupsAccordion">
            <div class="accordion-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="fas fa-tag"></i> Tên đề</th>
                                <th><i class="fas fa-file"></i> File</th>
                                <th><i class="fas fa-key"></i> Mã PIN</th>
                                <th><i class="fas fa-clock"></i> Thời gian mở</th>
                                <th><i class="fas fa-clock"></i> Thời gian hết hạn</th>
                                <th><i class="fas fa-cogs"></i> Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in data.exams %}
                            <tr>
                                <td>{{ e[4] }}</td>
                                <td>{{ e[1] }}</td>
                                <td><span class="badge bg-dark font-monospace">{{ e[5] }}</span></td>
                                <td>{{ e[2] }}</td>
                                <td>{{ e[3] }}</td>
                                <td>
                                    <div class="mb-2">
                                        <span class="badge bg-primary mb-1">Chức năng chính</span><br>
                                        <a href="{{ url_for('stream_exam_teacher', eid=e[0]) }}" class="btn btn-primary btn-sm me-1" target="_blank" title="Xem nội dung đề thi" style="display:none;">
                                            <i class="fas fa-eye"></i> Xem
                                        </a>
                                        {% if e[6] != 'expired' %}
                                        <a href="{{ url_for('edit_exam', eid=e[0]) }}" class="btn btn-secondary btn-sm me-1" title="Chỉnh sửa cấu hình">
                                            <i class="fas fa-edit"></i> Sửa
                                        </a>
                                        {% else %}
                                        <button class="btn btn-secondary btn-sm me-1" disabled title="Đề thi đã hết hạn, không thể sửa">
                                            <i class="fas fa-edit"></i> Sửa
                                        </button>
                                        {% endif %}
                                        <a href="/teacher/exam_logs/{{ e[0] }}" class="btn btn-info btn-sm me-1 text-white" title="Xem nhật ký truy cập">
                                            <i class="fas fa-history"></i> Logs
                                        </a>
                                        <a href="{{ url_for('teacher_submissions', eid=e[0]) }}" class="btn btn-warning btn-sm me-1 text-dark" title="Xem bài nộp của sinh viên">
                                            <i class="fas fa-file-alt"></i> Bài nộp
                                        </a>
                                        <a href="{{ url_for('delete_exam', eid=e[0]) }}" class="btn btn-danger btn-sm" onclick="return confirm('Bạn có chắc muốn xóa đề thi này?')">
                                            <i class="fas fa-trash"></i> Xóa
                                        </a>
                                    </div>
                                    <div class="border-top pt-2">
                                        <span class="badge bg-warning text-dark mb-1">Demo / Debug</span><br>
                                        <a href="{{ url_for('preview_encrypted', eid=e[0]) }}" class="btn btn-outline-dark btn-sm me-1" target="_blank" title="Xem file đã mã hoá (Hex view)">
                                            <i class="fas fa-file-code"></i> Xem Enc
                                        </a>
                                        <a href="/teacher/debug_exam/{{ e[0] }}" class="btn btn-dark btn-sm me-1" title="Soi chi tiết kỹ thuật Crypto">
                                            <i class="fas fa-microchip"></i> Soi
                                        </a>
                                        <a href="{{ url_for('tamper_exam', eid=e[0]) }}" class="btn btn-warning btn-sm me-1" onclick="return confirm('CẢNH BÁO: Hành động này sẽ sửa đổi 1 byte trong file mã hoá để giả lập tấn công. File sẽ bị hỏng. Tiếp tục?')" style="display:none;">
                                            <i class="fas fa-bug"></i> Phá
                                        </a>
                                        <a href="{{ url_for('restore_exam', eid=e[0]) }}" class="btn btn-success btn-sm me-1" title="Khôi phục file gốc" style="display:none;">
                                            <i class="fas fa-tools"></i> Fix
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-4">
    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
    <h5 class="text-muted">Chưa có đề thi nào.</h5>
    <p class="text-muted">Hãy upload đề thi đầu tiên của bạn!</p>
</div>
{% endif %}
{% endblock %}
